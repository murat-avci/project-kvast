"use strict";function toSize(e){return{y:e.top,height:e.bottom-e.top,x:e.left,width:e.right-e.left}}function savePixmap(e,t,r,o){var i,n,a=".png";if(r&&o){_logger.log("pixmap.bounds:",e.bounds);var g=toSize(e.bounds);_logger.log("pixmap.size:",g),g.height>r.height||g.width>r.width?_logger.log("using extract:",r):(n=utils.calculatePadding(e.bounds,o),_logger.log("using padding:",n))}var s={padding:n,extract:i,_scale:1,format:"png"},p=t+a;return utils.checkPathCreateIfNotExists(p),_logger.log("saving to",p),_generator.savePixmap(e,p,s).then(function(e){_logger.log("saved to",e)})["catch"](function(e){throw _logger.log("failed to save pixmap:",e),e})}function saveSvg(e,t,r){var o=e+".svg",i=generateFileName(o,"1000","svg");if(_logger.log("saving to",i),1398163232==r.smartObjectFileType)return utils.checkPathCreateIfNotExists(i),sendJsx("exportSvg.jsx",{layer:r,path:i});var n={scale:1};return _generator.getSVG(t,r.id,n).then(function(e){utils.saveFileToDisk(i,e)},function(e){_logger.log(e)})}function savePng(e,t,r,o,i){var n,a=(new Date).getTime();return o&&(n=Math.max(o.height,o.width)),_logger.log("getting pixmap for:",r),_generator.getPixmap(t,r,{convertToWorkingRGBProfile:!0,maxDimension:n,thread:!0}).then(function(t){return _logger.log("pixmap received in",(new Date).getTime()-a,"ms"),0==t.height||0==t.width?(_logger.log("invalid pixmap dimension.."),Q.reject(new Error("invalid pixmap"))):(_logger.log("saving pixmap"),savePixmap(t,e,o,i))})["catch"](function(e){return _logger.log(e),Q.reject(e)})}function ensurePath(e,t,r){if(t)for(var o=e+"."+r,i=0;i<t.length;i++)utils.checkPathCreateIfNotExists(generateFileName(o,t[i],r))}function sendJsx(e,t){var r=path.resolve(__dirname+"/jsx",e);return _generator.evaluateJSXFile(r,t)}function generateFileName(e,t,r){return e.replace("__factor__",t).replace("__format__",r)}var utils=require("./utils"),path=require("path"),Q=require("q"),_generator,_logger,Exporter=function(e,t){_generator=e,_logger=t};Exporter.prototype.exportArtboardPng=function(e,t,r){var o=path.resolve(utils.getZeplinTempDir()+e.randId+".zeplindump/exports/screens/"+t.id);return savePng(o,e.id,t.id,r.rect,t.bounds)},Exporter.prototype.exportAssets=function(e,t,r){var o=path.resolve(utils.getZeplinTempDir()+e.randId+".zeplindump/exports/assets/__format__/__factor__/"+t.id);return ensurePath(o,r.png,"png"),ensurePath(o,r.png,"jpg"),ensurePath(o,r.pdf,"pdf"),sendJsx("exportAssets.jsx",{exportBasePath:path.resolve(utils.getZeplinTempDir()+e.randId+".zeplindump"),asset:t,factors:r})},Exporter.prototype.exportAssetSvg=function(e,t){var r=path.resolve(utils.getZeplinTempDir()+e.randId+".zeplindump/exports/assets/__format__/__factor__/"+t.id);return saveSvg(r,e.id,t)},module.exports=Exporter;