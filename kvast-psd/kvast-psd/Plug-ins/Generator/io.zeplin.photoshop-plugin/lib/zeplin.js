function handleError(e,r){var t={message:e.message,stack:JSON.stringify(e.stack)};r.emit("parseError",{error:t,layerName:parser.getLayerInProgress(),artboardName:_artboardInProgress}),_logger.log("parsing failed..",{error:e.stack,layerName:parser.getLayerInProgress(),artboardName:_artboardInProgress}),_exportInProgress=!1,_artboardInProgress=void 0}function imagePerAsset(e){var r=0;return e.png&&(r+=e.png.length),e.pdf&&(r+=e.pdf.length),e.svg&&(r+=e.svg.length),r}function processAssets(e,r,t,n,o){var s=utils.assetFactors(e.type,e.density),a=0,i=t.length+n.length*imagePerAsset(s),l=Q.defer(),u=Q.defer();return t.reduce(function(e,t){return e.then(function(){return _logger.log("exporting artboard png"),exporter.exportArtboardPng(r,t.psLayer,t).then(function(){return o.emit("progress",{count:++a,total:i})})})},Q()).then(function(){l.resolve()})["catch"](function(e){throw l.reject(e),e}),n.length>0?(_logger.log("starting to export assets:",n.length),n.reduce(function(e,t){return e.then(function(){return _logger.log("exporting png & jpg & pdf"),exporter.exportAssets(r,t,s).then(function(){return s.png&&(a+=s.png.length),s.pdf&&(a+=1),o.emit("progress",{count:a,total:i})})}).then(function(){if(s.svg&&canSVGAssetBeGenerated(t))return _logger.log("exporting svg"),exporter.exportAssetSvg(r,t).then(function(){return o.emit("progress",{count:++a,total:i})})})},Q()).then(function(){u.resolve()})["catch"](function(e){throw _logger.log(e),u.reject(e),e})):u.resolve(),Q.allSettled([l.promise,u.promise]).then(function(e){e.forEach(function(e){if("rejected"==e.state)throw new Error(e.reason)})})}function canSVGAssetBeGenerated(e){return isEmbeddedSVGSmartObject(e.smartObjectFileType)||!isAISmartObject(e.smartObjectFileType)&&!isPSBSmartObject(e.smartObjectFileType)&&!e.pixels}function isEmbeddedSVGSmartObject(e){return 1398163232===e}function isAISmartObject(e){return 0===e||1346651680===e}function isPSBSmartObject(e){return 943870018===e}function fetchActiveDocument(){var e={compInfo:!1,imageInfo:!1,layerInfo:!1,expandSmartObjects:!1,getTextStyles:!1,getFullTextStyles:!1,selectedLayers:!1,getCompLayerSettings:!1,getDefaultLayerFX:!1,getPathData:!1};return _generator.getDocumentInfo(void 0,e)}function triggerUpdate(e,r){fetchActiveDocument().then(function(t){var n=fetchSelectionInfo(t.layers,t.selection),o=findArtboards(t).map(function(e){return{id:e.id,name:e.name}});e.emit("activeDocumentChanged",{id:r,selection:n,artboards:o})})}function fetchSelectionInfo(e,r){var t=[];return e&&e.forEach(function(e){r&&r.indexOf(e.index)!==-1&&t.push({id:e.id,name:e.name,type:utils.getLayerType(e),exportable:utils.isExportable(e),skippable:utils.isSkippable(e)}),e.layers&&(t=t.concat(fetchSelectionInfo(e.layers,r)))}),t}function findArtboards(e){return e.layers.filter(function(r){return utils.isArtboard(r)&&hasSelectedLayer(r,e.selection)})}function parseArtboardsSequentially(e,r,t,n){return e.then(function(){if(r&&t<r.length){var e=n(r[t]);return parseArtboardsSequentially(e,r,t+1,n)}return Q.resolve()})}function hasSelectedLayer(e,r){var t=!1;if(e)if(r&&r.indexOf(e.index)!==-1)t=!0;else{var n=e.layers;if(n)for(var o=0;o<n.length;o++)if(hasSelectedLayer(n[o],r)){t=!0;break}}return t}function sendJsx(e,r){var t=path.resolve(__dirname+"/jsx",e);return _generator.evaluateJSXFile(t,r)}var uuid=require("uuid"),os=require("os"),Q=require("q"),path=require("path"),utils=require("./utils"),Parser=require("./parser"),Exporter=require("./exporter"),exporter,parser,_generator,_logger,Zeplin=function(e,r){_generator=e,_logger=r,exporter=new Exporter(e,r),parser=new Parser(e,r)},_exportInProgress,_artboardInProgress;Zeplin.prototype["export"]=function(e,r,t){_exportInProgress=!0;var n=uuid.v4(),o={compInfo:!1,imageInfo:!0,layerInfo:!0,expandSmartObjects:!0,getTextStyles:!0,getFullTextStyles:!0,selectedLayers:!1,getCompLayerSettings:!1,getDefaultLayerFX:!0,getPathData:!1};_generator.getDocumentInfo(e,o).then(function(o){o.randId=n,sendJsx("getGuides.jsx").then(function(e){o.guides=e;var r={screens:[],assetIds:[]};return parseArtboardsSequentially(Q(),o.layers,0,function(e){var t=Q.defer();return utils.isArtboard(e)&&hasSelectedLayer(e,o.selection)?sendJsx("getArtboardColor.jsx",{layerId:e.id}).then(function(n){e.backgroundColor=n,_artboardInProgress=e.name;var s=parser.parseArtBoard(o,e);r.assetIds=r.assetIds.concat(s.assets),r.screens.push(s),t.resolve()},function(e){t.reject(e)}):(t.resolve(),t.promise)}).then(function(){return _logger.log("completed parsing.."),r},function(e){return handleError(e,t),Q.reject(e)})}).then(function(n){0===n.screens.length?(t.emit("complete"),_logger.log("No artboard is found!")):processAssets(r,o,n.screens,n.assetIds,t).then(function(){var s=JSON.stringify({source:"psd",name:"Photoshop",v:utils.V,sourceVersion:utils.getPhotoshopVersion(),pluginVersion:utils.getPluginVersion(),pluginBaseDir:utils.getGeneratorPluginPath(),filePath:o.file,project:{pid:r.pid,density:r.density,type:r.type,name:r.name},replace:r.replace,screens:n.screens.map(function(e){return delete e.psLayer,delete e.assets,e})}),a=utils.getZeplinTempDir()+o.randId+".zeplindump",i=a+"/export.json";utils.saveFileToDisk(i,s),_exportInProgress=!1,_logger.log("export is completed, opening Zeplin.."),t.emit("complete"),utils.openZeplin(a),triggerUpdate(t,e)},function(e){_logger.log("handling asset export error.."),handleError(e,t)})})},function(e){_logger.log(e);var r={message:e.message,stack:JSON.stringify(e.stack)};t.emit("parseError",{error:r}),_exportInProgress=!1,_artboardInProgress=void 0}).done()},Zeplin.prototype.setLayerFlag=function(e,r,t){if(r){var n;switch(e){case utils.EXPORT_FLAG:n=t?utils.isExportable:utils.isExported;break;case utils.SKIP_FLAG:n=t?utils.isSkippable:utils.isSkipped}if(Array.isArray(r)){var o=r;r=r.filter(function(e){return"artboard"!==e.type&&n(e)}),r.length>0?sendJsx("markLayers.jsx",{selection:o,layers:r,flag:e,add:t}):_logger.log("No suitable layer is selected!")}else n(r)?sendJsx("markLayers.jsx",{layers:[r],flag:e,add:t}):_logger.log("No suitable layer is selected!")}},Zeplin.prototype.exportInProgress=function(){return _exportInProgress},Zeplin.prototype.triggerPanelUpdate=function(e,r){triggerUpdate(e,r)},Zeplin.prototype.predictProjectDensity=function(){return fetchActiveDocument().then(function(e){var r=findArtboards(e).map(function(e){return parser.calculateArtboardDimensions(e)}).map(function(e){return utils.predictArtboardDensity(e.width,e.height)});if(r.length>0){var t=r.reduce(function(e,r){return e.ios!==r.ios&&(e.ios=void 0),e.android!==r.android&&(e.android=void 0),e.web!==r.web&&(e.web=void 0),e},r[0]);return t}})},module.exports=Zeplin;